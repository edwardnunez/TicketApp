<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: backend/gatewayservice/__tests__/gateway-service.test.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: backend/gatewayservice/__tests__/gateway-service.test.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import request from "supertest";
import nock from "nock";
import jwt from "jsonwebtoken";

let app;
const JWT_SECRET = "test-secret-key";

// URLs de los microservicios
const USER_SERVICE_URL = "http://localhost:8001";
const TICKET_SERVICE_URL = "http://localhost:8002";
const EVENT_SERVICE_URL = "http://localhost:8003";
const LOCATION_SERVICE_URL = "http://localhost:8004";

/**
 * Helper para generar tokens JWT de prueba
 */
const generateToken = (payload) => {
  return jwt.sign(payload, JWT_SECRET, { expiresIn: "1h" });
};

/**
 * Tokens de prueba
 */
const tokens = {
  admin: generateToken({ userId: "admin123", role: "admin", username: "admin" }),
  user: generateToken({ userId: "user123", role: "user", username: "testuser" }),
  otherUser: generateToken({ userId: "user456", role: "user", username: "otheruser" }),
  expired: jwt.sign({ userId: "user123", role: "user" }, JWT_SECRET, { expiresIn: "-1h" }),
  invalid: "invalid.token.here"
};

beforeAll(async () => {
  // Configurar variables de entorno para las pruebas
  process.env.JWT_SECRET = JWT_SECRET;
  process.env.USER_SERVICE_URL = USER_SERVICE_URL;
  process.env.TICKET_SERVICE_URL = TICKET_SERVICE_URL;
  process.env.EVENT_SERVICE_URL = EVENT_SERVICE_URL;
  process.env.LOCATION_SERVICE_URL = LOCATION_SERVICE_URL;

  // Importar la aplicación
  const { default: gatewayService } = await import("../gateway-service.js");
  app = gatewayService;
});

afterAll(async () => {
  if (app &amp;&amp; typeof app.close === 'function') {
    app.close();
  }
});

afterEach(() => {
  nock.cleanAll();
});

describe("Gateway Service - Integration Tests", () => {

  describe("Health Check", () => {
    it("GET /health - debería retornar estado OK", async () => {
      const response = await request(app).get("/health");

      expect(response.status).toBe(200);
      expect(response.body).toEqual({ status: "OK" });
    });
  });

  describe("User Routes", () => {

    describe("POST /login", () => {
      it("debería hacer proxy de login exitoso al user service", async () => {
        const loginData = { username: "testuser", password: "testpass" };
        const mockResponse = {
          token: "jwt-token-123",
          user: { id: "user123", username: "testuser", email: "test@example.com" }
        };

        nock(USER_SERVICE_URL)
          .post("/login", loginData)
          .reply(200, mockResponse);

        const response = await request(app)
          .post("/login")
          .send(loginData);

        expect(response.status).toBe(200);
        expect(response.body).toEqual(mockResponse);
      });

      it("debería retornar error 401 si las credenciales son inválidas", async () => {
        const loginData = { username: "testuser", password: "wrongpass" };

        nock(USER_SERVICE_URL)
          .post("/login", loginData)
          .reply(401, { error: "Credenciales inválidas" });

        const response = await request(app)
          .post("/login")
          .send(loginData);

        expect(response.status).toBe(401);
        expect(response.body).toHaveProperty("error");
      });
    });

    describe("POST /adduser", () => {
      it("debería registrar un nuevo usuario correctamente", async () => {
        const userData = {
          username: "newuser",
          password: "TestPass123",
          name: "New",
          surname: "User",
          email: "new@example.com"
        };

        const mockResponse = {
          success: true,
          userId: "newuser123",
          message: "Usuario creado exitosamente"
        };

        nock(USER_SERVICE_URL)
          .post("/adduser", userData)
          .reply(200, mockResponse);

        const response = await request(app)
          .post("/adduser")
          .send(userData);

        expect(response.status).toBe(200);
        expect(response.body).toEqual(mockResponse);
      });

      it("debería retornar error si el username ya existe", async () => {
        const userData = {
          username: "existinguser",
          password: "TestPass123",
          name: "Test",
          surname: "User",
          email: "test@example.com"
        };

        nock(USER_SERVICE_URL)
          .post("/adduser", userData)
          .reply(400, { error: "El nombre de usuario ya existe" });

        const response = await request(app)
          .post("/adduser")
          .send(userData);

        expect(response.status).toBe(400);
        expect(response.body).toHaveProperty("error");
      });
    });

    describe("GET /users (Admin only)", () => {
      it("debería permitir acceso con token de admin", async () => {
        const mockUsers = [
          { id: "user1", username: "user1", email: "user1@example.com" },
          { id: "user2", username: "user2", email: "user2@example.com" }
        ];

        nock(USER_SERVICE_URL)
          .get("/users")
          .reply(200, mockUsers);

        const response = await request(app)
          .get("/users")
          .set("Authorization", `Bearer ${tokens.admin}`);

        expect(response.status).toBe(200);
        expect(response.body).toEqual(mockUsers);
      });

      it("debería denegar acceso sin token", async () => {
        const response = await request(app)
          .get("/users");

        expect(response.status).toBe(401);
        expect(response.body).toHaveProperty("error");
        expect(response.body.message).toContain("autenticación");
      });

      it("debería denegar acceso con token de usuario normal", async () => {
        const response = await request(app)
          .get("/users")
          .set("Authorization", `Bearer ${tokens.user}`);

        expect(response.status).toBe(403);
        expect(response.body).toHaveProperty("error");
        expect(response.body.message).toContain("permisos de administrador");
      });

      it("debería denegar acceso con token expirado", async () => {
        const response = await request(app)
          .get("/users")
          .set("Authorization", `Bearer ${tokens.expired}`);

        expect(response.status).toBe(401);
        expect(response.body.error).toBe("Token expirado");
      });

      it("debería denegar acceso con token inválido", async () => {
        const response = await request(app)
          .get("/users")
          .set("Authorization", `Bearer ${tokens.invalid}`);

        expect(response.status).toBe(401);
        expect(response.body.error).toBe("Token inválido");
      });
    });

    describe("GET /users/search", () => {
      it("debería buscar usuario por username", async () => {
        const mockUser = { id: "user123", username: "testuser", email: "test@example.com" };

        nock(USER_SERVICE_URL)
          .get("/users/search?username=testuser")
          .reply(200, mockUser);

        const response = await request(app)
          .get("/users/search?username=testuser");

        expect(response.status).toBe(200);
        expect(response.body).toEqual(mockUser);
      });

      it("debería buscar usuario por userId", async () => {
        const mockUser = { id: "user123", username: "testuser", email: "test@example.com" };

        nock(USER_SERVICE_URL)
          .get("/users/search?userId=user123")
          .reply(200, mockUser);

        const response = await request(app)
          .get("/users/search?userId=user123");

        expect(response.status).toBe(200);
        expect(response.body).toEqual(mockUser);
      });
    });

    describe("PUT /edit-user/:userId (Protected - Ownership)", () => {
      it("debería permitir a usuario editar su propio perfil", async () => {
        const userId = "user123";
        const updateData = { name: "Updated", surname: "Name" };
        const mockResponse = { success: true, user: { ...updateData, id: userId } };

        nock(USER_SERVICE_URL)
          .put(`/edit-user/${userId}`, updateData)
          .reply(200, mockResponse);

        const response = await request(app)
          .put(`/edit-user/${userId}`)
          .set("Authorization", `Bearer ${tokens.user}`)
          .send(updateData);

        expect(response.status).toBe(200);
        expect(response.body).toEqual(mockResponse);
      });

      it("debería denegar acceso sin autenticación", async () => {
        const response = await request(app)
          .put("/edit-user/user123")
          .send({ name: "Updated" });

        expect(response.status).toBe(401);
        expect(response.body).toHaveProperty("error");
      });

      it("debería denegar a usuario editar perfil de otro usuario", async () => {
        const response = await request(app)
          .put("/edit-user/user456")
          .set("Authorization", `Bearer ${tokens.user}`)
          .send({ name: "Hacked" });

        expect(response.status).toBe(403);
        expect(response.body.error).toBe("Acceso denegado");
        expect(response.body.message).toContain("permiso");
      });
    });

    describe("POST /verifyToken", () => {
      it("debería verificar token válido", async () => {
        const mockResponse = { valid: true, userId: "user123" };

        nock(USER_SERVICE_URL)
          .post("/verifyToken", { token: "valid-token" })
          .reply(200, mockResponse);

        const response = await request(app)
          .post("/verifyToken")
          .send({ token: "valid-token" });

        expect(response.status).toBe(200);
        expect(response.body).toEqual(mockResponse);
      });
    });
  });

  describe("Ticket Routes", () => {

    describe("GET /tickets/occupied/:eventId", () => {
      it("debería obtener asientos ocupados de un evento", async () => {
        const eventId = "event123";
        const mockResponse = {
          success: true,
          occupiedSeats: ["seat-1-1", "seat-1-2", "seat-2-5"]
        };

        nock(TICKET_SERVICE_URL)
          .get(`/tickets/occupied/${eventId}`)
          .reply(200, mockResponse);

        const response = await request(app)
          .get(`/tickets/occupied/${eventId}`);

        expect(response.status).toBe(200);
        expect(response.body).toEqual(mockResponse);
      });
    });

    describe("POST /tickets/purchase (Protected - Authenticated)", () => {
      it("debería permitir compra de tickets con autenticación", async () => {
        const purchaseData = {
          eventId: "event123",
          userId: "user123",
          selectedSeats: [{ id: "seat-1-1", price: 50 }],
          price: 50,
          quantity: 1,
          customerInfo: { name: "Test", email: "test@test.com", phone: "123" }
        };

        const mockResponse = {
          success: true,
          ticket: { id: "ticket123", ...purchaseData },
          qrCode: "qr-code-base64"
        };

        nock(TICKET_SERVICE_URL)
          .post("/tickets/purchase", purchaseData)
          .reply(200, mockResponse);

        const response = await request(app)
          .post("/tickets/purchase")
          .set("Authorization", `Bearer ${tokens.user}`)
          .send(purchaseData);

        expect(response.status).toBe(200);
        expect(response.body).toEqual(mockResponse);
      });

      it("debería denegar compra sin autenticación", async () => {
        const response = await request(app)
          .post("/tickets/purchase")
          .send({ eventId: "event123" });

        expect(response.status).toBe(401);
        expect(response.body).toHaveProperty("error");
      });
    });

    describe("GET /tickets/user/:userId/details (Protected - Ownership)", () => {
      it("debería permitir a usuario ver sus propios tickets", async () => {
        const userId = "user123";
        const mockResponse = {
          success: true,
          tickets: [
            { id: "ticket1", eventId: "event1", seats: ["seat-1-1"] },
            { id: "ticket2", eventId: "event2", seats: ["seat-2-2"] }
          ]
        };

        nock(TICKET_SERVICE_URL)
          .get(`/tickets/user/${userId}/details`)
          .reply(200, mockResponse);

        const response = await request(app)
          .get(`/tickets/user/${userId}/details`)
          .set("Authorization", `Bearer ${tokens.user}`);

        expect(response.status).toBe(200);
        expect(response.body).toEqual(mockResponse);
      });

      it("debería denegar a usuario ver tickets de otro usuario", async () => {
        const response = await request(app)
          .get("/tickets/user/user456/details")
          .set("Authorization", `Bearer ${tokens.user}`);

        expect(response.status).toBe(403);
        expect(response.body.error).toBe("Acceso denegado");
      });
    });

    describe("GET /tickets/user/:userId (Protected - Ownership)", () => {
      it("debería permitir a usuario ver sus tickets", async () => {
        const userId = "user123";
        const mockResponse = {
          success: true,
          tickets: [{ id: "ticket1" }, { id: "ticket2" }]
        };

        nock(TICKET_SERVICE_URL)
          .get(`/tickets/user/${userId}`)
          .reply(200, mockResponse);

        const response = await request(app)
          .get(`/tickets/user/${userId}`)
          .set("Authorization", `Bearer ${tokens.user}`);

        expect(response.status).toBe(200);
        expect(response.body).toEqual(mockResponse);
      });
    });

    describe("GET /tickets/event/:eventId", () => {
      it("debería obtener tickets de un evento", async () => {
        const eventId = "event123";
        const mockResponse = {
          success: true,
          tickets: [{ id: "ticket1" }, { id: "ticket2" }],
          statistics: { total: 2, sold: 2 }
        };

        nock(TICKET_SERVICE_URL)
          .get(`/tickets/event/${eventId}`)
          .reply(200, mockResponse);

        const response = await request(app)
          .get(`/tickets/event/${eventId}`);

        expect(response.status).toBe(200);
        expect(response.body).toEqual(mockResponse);
      });
    });

    describe("GET /tickets/:id", () => {
      it("debería obtener un ticket por ID", async () => {
        const ticketId = "ticket123";
        const mockResponse = {
          success: true,
          ticket: { id: ticketId, eventId: "event123", userId: "user123" }
        };

        nock(TICKET_SERVICE_URL)
          .get(`/tickets/${ticketId}`)
          .reply(200, mockResponse);

        const response = await request(app)
          .get(`/tickets/${ticketId}`);

        expect(response.status).toBe(200);
        expect(response.body).toEqual(mockResponse);
      });
    });

    describe("GET /tickets/:id/qr", () => {
      it("debería obtener QR code de un ticket", async () => {
        const ticketId = "ticket123";
        const mockResponse = {
          success: true,
          qrCode: "base64-qr-code",
          ticketNumber: "TKT-12345"
        };

        nock(TICKET_SERVICE_URL)
          .get(`/tickets/${ticketId}/qr`)
          .reply(200, mockResponse);

        const response = await request(app)
          .get(`/tickets/${ticketId}/qr`);

        expect(response.status).toBe(200);
        expect(response.body).toEqual(mockResponse);
      });
    });

    describe("GET /tickets/user/:userId/events (Protected - Ownership)", () => {
      it("debería obtener eventos de tickets del usuario", async () => {
        const userId = "user123";
        const mockResponse = {
          success: true,
          events: [{ id: "event1", name: "Concierto 1" }]
        };

        nock(TICKET_SERVICE_URL)
          .get(`/tickets/user/${userId}/events`)
          .reply(200, mockResponse);

        const response = await request(app)
          .get(`/tickets/user/${userId}/events`)
          .set("Authorization", `Bearer ${tokens.user}`);

        expect(response.status).toBe(200);
        expect(response.body).toEqual(mockResponse);
      });
    });

    describe("GET /tickets/admin/statistics (Admin only)", () => {
      it("debería permitir a admin ver estadísticas", async () => {
        const mockResponse = {
          success: true,
          statistics: {
            totalTickets: 1000,
            totalRevenue: 50000,
            byEvent: []
          }
        };

        nock(TICKET_SERVICE_URL)
          .get("/tickets/admin/statistics")
          .reply(200, mockResponse);

        const response = await request(app)
          .get("/tickets/admin/statistics")
          .set("Authorization", `Bearer ${tokens.admin}`);

        expect(response.status).toBe(200);
        expect(response.body).toEqual(mockResponse);
      });

      it("debería denegar acceso a usuario normal", async () => {
        const response = await request(app)
          .get("/tickets/admin/statistics")
          .set("Authorization", `Bearer ${tokens.user}`);

        expect(response.status).toBe(403);
      });
    });

    describe("DELETE /tickets/event/:eventId (Admin only)", () => {
      it("debería permitir a admin eliminar tickets de un evento", async () => {
        const eventId = "event123";
        const mockResponse = { success: true, deletedCount: 5 };

        nock(TICKET_SERVICE_URL)
          .delete(`/tickets/event/${eventId}`)
          .reply(200, mockResponse);

        const response = await request(app)
          .delete(`/tickets/event/${eventId}`)
          .set("Authorization", `Bearer ${tokens.admin}`);

        expect(response.status).toBe(200);
        expect(response.body).toEqual(mockResponse);
      });

      it("debería denegar a usuario normal", async () => {
        const response = await request(app)
          .delete("/tickets/event/event123")
          .set("Authorization", `Bearer ${tokens.user}`);

        expect(response.status).toBe(403);
      });
    });

    describe("DELETE /tickets/:id", () => {
      it("debería cancelar un ticket", async () => {
        const ticketId = "ticket123";
        const mockResponse = {
          success: true,
          message: "Ticket cancelado exitosamente"
        };

        nock(TICKET_SERVICE_URL)
          .delete(`/tickets/${ticketId}`)
          .reply(200, mockResponse);

        const response = await request(app)
          .delete(`/tickets/${ticketId}`);

        expect(response.status).toBe(200);
        expect(response.body).toEqual(mockResponse);
      });
    });
  });

  describe("Event Routes", () => {

    describe("POST /events (Admin only)", () => {
      it("debería permitir a admin crear un evento", async () => {
        const eventData = {
          name: "Concierto de Rock",
          description: "Un gran concierto",
          date: "2024-12-31T20:00:00Z",
          location: "loc123",
          price: 50,
          type: "concert",
          capacity: 1000
        };

        const mockResponse = {
          success: true,
          event: { id: "event123", ...eventData }
        };

        nock(EVENT_SERVICE_URL)
          .post("/event", eventData)
          .reply(200, mockResponse);

        const response = await request(app)
          .post("/events")
          .set("Authorization", `Bearer ${tokens.admin}`)
          .send(eventData);

        expect(response.status).toBe(200);
        expect(response.body).toEqual(mockResponse);
      });

      it("debería denegar a usuario normal", async () => {
        const response = await request(app)
          .post("/events")
          .set("Authorization", `Bearer ${tokens.user}`)
          .send({ name: "Test Event" });

        expect(response.status).toBe(403);
      });
    });

    describe("PUT /events/:eventId (Admin only)", () => {
      it("debería permitir a admin actualizar un evento", async () => {
        const eventId = "event123";
        const updateData = { name: "Concierto Actualizado", price: 75 };
        const mockResponse = { success: true, event: { id: eventId, ...updateData } };

        nock(EVENT_SERVICE_URL)
          .put(`/events/${eventId}`, updateData)
          .reply(200, mockResponse);

        const response = await request(app)
          .put(`/events/${eventId}`)
          .set("Authorization", `Bearer ${tokens.admin}`)
          .send(updateData);

        expect(response.status).toBe(200);
        expect(response.body).toEqual(mockResponse);
      });
    });

    describe("PATCH /events/:eventId/image (Admin only)", () => {
      it("debería permitir a admin actualizar imagen del evento", async () => {
        const eventId = "event123";
        const imageData = { image: "base64-image-data" };
        const mockResponse = { success: true, event: { id: eventId, ...imageData } };

        nock(EVENT_SERVICE_URL)
          .patch(`/events/${eventId}/image`, imageData)
          .reply(200, mockResponse);

        const response = await request(app)
          .patch(`/events/${eventId}/image`)
          .set("Authorization", `Bearer ${tokens.admin}`)
          .send(imageData);

        expect(response.status).toBe(200);
        expect(response.body).toEqual(mockResponse);
      });
    });

    describe("GET /events", () => {
      it("debería obtener todos los eventos (público)", async () => {
        const mockResponse = {
          success: true,
          events: [
            { id: "event1", name: "Concierto 1" },
            { id: "event2", name: "Concierto 2" }
          ]
        };

        nock(EVENT_SERVICE_URL)
          .get("/events")
          .reply(200, mockResponse);

        const response = await request(app)
          .get("/events");

        expect(response.status).toBe(200);
        expect(response.body).toEqual(mockResponse);
      });
    });

    describe("GET /events/:eventId", () => {
      it("debería obtener un evento específico (público)", async () => {
        const eventId = "event123";
        const mockResponse = {
          success: true,
          event: { id: eventId, name: "Concierto de Rock", price: 50 }
        };

        nock(EVENT_SERVICE_URL)
          .get(`/events/${eventId}`)
          .reply(200, mockResponse);

        const response = await request(app)
          .get(`/events/${eventId}`);

        expect(response.status).toBe(200);
        expect(response.body).toEqual(mockResponse);
      });
    });

    describe("POST /events/update-states (Admin only)", () => {
      it("debería permitir a admin actualizar estados de eventos", async () => {
        const mockResponse = { success: true, updatedCount: 5 };

        nock(EVENT_SERVICE_URL)
          .post("/events/update-states", {})
          .reply(200, mockResponse);

        const response = await request(app)
          .post("/events/update-states")
          .set("Authorization", `Bearer ${tokens.admin}`)
          .send({});

        expect(response.status).toBe(200);
        expect(response.body).toEqual(mockResponse);
      });
    });

    describe("GET /events/stats/states (Admin only)", () => {
      it("debería permitir a admin ver estadísticas por estado", async () => {
        const mockResponse = {
          success: true,
          stats: { active: 10, cancelled: 2, completed: 5 }
        };

        nock(EVENT_SERVICE_URL)
          .get("/events/stats/states")
          .reply(200, mockResponse);

        const response = await request(app)
          .get("/events/stats/states")
          .set("Authorization", `Bearer ${tokens.admin}`);

        expect(response.status).toBe(200);
        expect(response.body).toEqual(mockResponse);
      });
    });

    describe("PATCH /events/:eventId/state (Admin only)", () => {
      it("debería permitir a admin cambiar estado de evento", async () => {
        const eventId = "event123";
        const stateData = { state: "cancelled" };
        const mockResponse = { success: true, event: { id: eventId, state: "cancelled" } };

        nock(EVENT_SERVICE_URL)
          .patch(`/events/${eventId}/state`, stateData)
          .reply(200, mockResponse);

        const response = await request(app)
          .patch(`/events/${eventId}/state`)
          .set("Authorization", `Bearer ${tokens.admin}`)
          .send(stateData);

        expect(response.status).toBe(200);
        expect(response.body).toEqual(mockResponse);
      });
    });

    describe("PUT /events/:eventId/seat-blocks (Admin only)", () => {
      it("debería permitir a admin actualizar bloques de asientos", async () => {
        const eventId = "event123";
        const seatBlockData = { blocks: ["block-1", "block-2"] };
        const mockResponse = { success: true, seatBlocks: seatBlockData.blocks };

        nock(EVENT_SERVICE_URL)
          .put(`/events/${eventId}/seat-blocks`, seatBlockData)
          .reply(200, mockResponse);

        const response = await request(app)
          .put(`/events/${eventId}/seat-blocks`)
          .set("Authorization", `Bearer ${tokens.admin}`)
          .send(seatBlockData);

        expect(response.status).toBe(200);
        expect(response.body).toEqual(mockResponse);
      });
    });

    describe("DELETE /events/:eventId (Admin only)", () => {
      it("debería permitir a admin eliminar un evento", async () => {
        const eventId = "event123";
        const mockResponse = { success: true, message: "Evento eliminado" };

        nock(EVENT_SERVICE_URL)
          .delete(`/events/${eventId}`)
          .reply(200, mockResponse);

        const response = await request(app)
          .delete(`/events/${eventId}`)
          .set("Authorization", `Bearer ${tokens.admin}`);

        expect(response.status).toBe(200);
        expect(response.body).toEqual(mockResponse);
      });

      it("debería denegar a usuario normal", async () => {
        const response = await request(app)
          .delete("/events/event123")
          .set("Authorization", `Bearer ${tokens.user}`);

        expect(response.status).toBe(403);
      });
    });

    describe("DELETE /events/:eventId/cancel (Admin only)", () => {
      it("debería permitir a admin cancelar un evento", async () => {
        const eventId = "event123";
        const cancelData = { reason: "Mal tiempo" };
        const mockResponse = { success: true, message: "Evento cancelado" };

        nock(EVENT_SERVICE_URL)
          .delete(`/events/${eventId}/cancel`)
          .reply(200, mockResponse);

        const response = await request(app)
          .delete(`/events/${eventId}/cancel`)
          .set("Authorization", `Bearer ${tokens.admin}`)
          .send(cancelData);

        expect(response.status).toBe(200);
        expect(response.body).toEqual(mockResponse);
      });
    });

    describe("GET /events/admin/statistics (Admin only)", () => {
      it("debería permitir a admin ver estadísticas de eventos", async () => {
        const mockResponse = {
          success: true,
          statistics: {
            totalEvents: 100,
            totalRevenue: 100000,
            activeEvents: 60
          }
        };

        nock(EVENT_SERVICE_URL)
          .get("/events/admin/statistics")
          .reply(200, mockResponse);

        const response = await request(app)
          .get("/events/admin/statistics")
          .set("Authorization", `Bearer ${tokens.admin}`);

        expect(response.status).toBe(200);
        expect(response.body).toEqual(mockResponse);
      });

      it("debería denegar a usuario normal", async () => {
        const response = await request(app)
          .get("/events/admin/statistics")
          .set("Authorization", `Bearer ${tokens.user}`);

        expect(response.status).toBe(403);
      });
    });
  });

  describe("Location Routes", () => {

    describe("POST /location (Admin only)", () => {
      it("debería permitir a admin crear una ubicación", async () => {
        const locationData = {
          name: "Estadio Principal",
          category: "stadium",
          address: "Calle Principal 123",
          capacity: 50000
        };

        const mockResponse = {
          success: true,
          location: { id: "loc123", ...locationData }
        };

        nock(LOCATION_SERVICE_URL)
          .post("/location", locationData)
          .reply(200, mockResponse);

        const response = await request(app)
          .post("/location")
          .set("Authorization", `Bearer ${tokens.admin}`)
          .send(locationData);

        expect(response.status).toBe(200);
        expect(response.body).toEqual(mockResponse);
      });

      it("debería denegar a usuario normal", async () => {
        const response = await request(app)
          .post("/location")
          .set("Authorization", `Bearer ${tokens.user}`)
          .send({ name: "Test Location" });

        expect(response.status).toBe(403);
      });
    });

    describe("GET /locations", () => {
      it("debería obtener todas las ubicaciones (público)", async () => {
        const mockResponse = {
          success: true,
          locations: [
            { id: "loc1", name: "Estadio 1", category: "stadium" },
            { id: "loc2", name: "Teatro 1", category: "theater" }
          ]
        };

        nock(LOCATION_SERVICE_URL)
          .get("/locations")
          .reply(200, mockResponse);

        const response = await request(app)
          .get("/locations");

        expect(response.status).toBe(200);
        expect(response.body).toEqual(mockResponse);
      });
    });

    describe("GET /locations/:locationId", () => {
      it("debería obtener una ubicación específica (público)", async () => {
        const locationId = "loc123";
        const mockResponse = {
          success: true,
          location: { id: locationId, name: "Estadio Principal", category: "stadium" }
        };

        nock(LOCATION_SERVICE_URL)
          .get(`/locations/${locationId}`)
          .reply(200, mockResponse);

        const response = await request(app)
          .get(`/locations/${locationId}`);

        expect(response.status).toBe(200);
        expect(response.body).toEqual(mockResponse);
      });
    });

    describe("GET /seatmaps", () => {
      it("debería obtener todos los seatmaps (público)", async () => {
        const mockResponse = {
          success: true,
          seatmaps: [
            { id: "sm1", name: "SeatMap 1", type: "football" },
            { id: "sm2", name: "SeatMap 2", type: "theater" }
          ]
        };

        nock(LOCATION_SERVICE_URL)
          .get("/seatmaps")
          .reply(200, mockResponse);

        const response = await request(app)
          .get("/seatmaps");

        expect(response.status).toBe(200);
        expect(response.body).toEqual(mockResponse);
      });
    });

    describe("POST /seatmaps (Admin only)", () => {
      it("debería permitir a admin crear un seatmap", async () => {
        const seatmapData = {
          name: "Estadio SeatMap",
          type: "football",
          sections: [
            { id: "vip", name: "VIP", rows: 5, seatsPerRow: 20, defaultPrice: 100 }
          ]
        };

        const mockResponse = {
          success: true,
          seatmap: { id: "sm123", ...seatmapData }
        };

        nock(LOCATION_SERVICE_URL)
          .post("/seatmaps", seatmapData)
          .reply(200, mockResponse);

        const response = await request(app)
          .post("/seatmaps")
          .set("Authorization", `Bearer ${tokens.admin}`)
          .send(seatmapData);

        expect(response.status).toBe(200);
        expect(response.body).toEqual(mockResponse);
      });

      it("debería denegar a usuario normal", async () => {
        const response = await request(app)
          .post("/seatmaps")
          .set("Authorization", `Bearer ${tokens.user}`)
          .send({ name: "Test Seatmap" });

        expect(response.status).toBe(403);
      });
    });

    describe("GET /seatmaps/:id", () => {
      it("debería obtener un seatmap específico (público)", async () => {
        const seatmapId = "sm123";
        const mockResponse = {
          success: true,
          seatmap: { id: seatmapId, name: "Estadio SeatMap", type: "football" }
        };

        nock(LOCATION_SERVICE_URL)
          .get(`/seatmaps/${seatmapId}`)
          .reply(200, mockResponse);

        const response = await request(app)
          .get(`/seatmaps/${seatmapId}`);

        expect(response.status).toBe(200);
        expect(response.body).toEqual(mockResponse);
      });
    });

    describe("GET /location/:locationId/sections", () => {
      it("debería obtener secciones de una ubicación (público)", async () => {
        const locationId = "loc123";
        const mockResponse = {
          success: true,
          sections: [
            { id: "vip", name: "VIP", capacity: 100 },
            { id: "general", name: "General", capacity: 900 }
          ]
        };

        nock(LOCATION_SERVICE_URL)
          .get(`/location/${locationId}/sections`)
          .reply(200, mockResponse);

        const response = await request(app)
          .get(`/location/${locationId}/sections`);

        expect(response.status).toBe(200);
        expect(response.body).toEqual(mockResponse);
      });
    });
  });

  describe("Middleware Integration Tests", () => {

    describe("verifyAdmin middleware", () => {
      it("debería rechazar sin header Authorization", async () => {
        const response = await request(app).get("/users");

        expect(response.status).toBe(401);
        expect(response.body.error).toBe("No se proporcionó token de autenticación");
      });

      it("debería rechazar con Bearer vacío", async () => {
        const response = await request(app)
          .get("/users")
          .set("Authorization", "Bearer ");

        expect(response.status).toBe(401);
      });

      it("debería rechazar con rol no-admin", async () => {
        const response = await request(app)
          .get("/users")
          .set("Authorization", `Bearer ${tokens.user}`);

        expect(response.status).toBe(403);
        expect(response.body.message).toContain("permisos de administrador");
      });

      it("debería aceptar con rol admin", async () => {
        nock(USER_SERVICE_URL)
          .get("/users")
          .reply(200, []);

        const response = await request(app)
          .get("/users")
          .set("Authorization", `Bearer ${tokens.admin}`);

        expect(response.status).toBe(200);
      });
    });

    describe("verifyAuthenticated middleware", () => {
      it("debería rechazar sin token", async () => {
        const response = await request(app)
          .post("/tickets/purchase")
          .send({});

        expect(response.status).toBe(401);
        expect(response.body.error).toBe("No autenticado");
      });

      it("debería rechazar con token expirado", async () => {
        const response = await request(app)
          .post("/tickets/purchase")
          .set("Authorization", `Bearer ${tokens.expired}`)
          .send({});

        expect(response.status).toBe(401);
        expect(response.body.error).toBe("Sesión expirada");
      });

      it("debería aceptar con token válido", async () => {
        nock(TICKET_SERVICE_URL)
          .post("/tickets/purchase")
          .reply(200, { success: true });

        const response = await request(app)
          .post("/tickets/purchase")
          .set("Authorization", `Bearer ${tokens.user}`)
          .send({
            eventId: "e1",
            userId: "user123",
            selectedSeats: [{ id: "s1", price: 50 }],
            price: 50,
            quantity: 1,
            customerInfo: { name: "T", email: "t@t.com", phone: "123" }
          });

        expect(response.status).toBe(200);
      });
    });

    describe("verifyOwnership middleware", () => {
      it("debería permitir acceso a propio recurso", async () => {
        nock(USER_SERVICE_URL)
          .put("/edit-user/user123")
          .reply(200, { success: true });

        const response = await request(app)
          .put("/edit-user/user123")
          .set("Authorization", `Bearer ${tokens.user}`)
          .send({ name: "Updated" });

        expect(response.status).toBe(200);
      });

      it("debería denegar acceso a recurso de otro usuario", async () => {
        const response = await request(app)
          .put("/edit-user/user456")
          .set("Authorization", `Bearer ${tokens.user}`)
          .send({ name: "Hacked" });

        expect(response.status).toBe(403);
        expect(response.body.error).toBe("Acceso denegado");
      });

      it("debería validar que token contenga userId", async () => {
        const tokenSinUserId = generateToken({ role: "user" });

        const response = await request(app)
          .put("/edit-user/user123")
          .set("Authorization", `Bearer ${tokenSinUserId}`)
          .send({ name: "Test" });

        expect(response.status).toBe(401);
        expect(response.body.message).toContain("información de usuario");
      });
    });
  });

  describe("Error Handling", () => {

    it("debería manejar error 500 del microservicio", async () => {
      nock(EVENT_SERVICE_URL)
        .get("/events")
        .reply(500, { error: "Internal Server Error" });

      const response = await request(app).get("/events");

      expect(response.status).toBe(500);
      expect(response.body).toHaveProperty("error");
    });

    it("debería manejar error 404 del microservicio", async () => {
      nock(EVENT_SERVICE_URL)
        .get("/events/nonexistent")
        .reply(404, { error: "Event not found" });

      const response = await request(app).get("/events/nonexistent");

      expect(response.status).toBe(404);
      expect(response.body).toHaveProperty("error");
    });
  });
});</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-components_colorscheme.html">components/colorscheme</a></li><li><a href="module-models_Event.html">models/Event</a></li><li><a href="module-models_Location.html">models/Location</a></li><li><a href="module-models_SeatMap.html">models/SeatMap</a></li><li><a href="module-models_Ticket.html">models/Ticket</a></li><li><a href="module-models_User.html">models/User</a></li><li><a href="module-services_UserService.html">services/UserService</a></li><li><a href="module-utils_api.html">utils/api</a></li><li><a href="module-utils_authSession.html">utils/authSession</a></li></ul><h3>Global</h3><ul><li><a href="global.html#AboutUs">AboutUs</a></li><li><a href="global.html#AdminDashboard">AdminDashboard</a></li><li><a href="global.html#AdminStatistics">AdminStatistics</a></li><li><a href="global.html#App">App</a></li><li><a href="global.html#BlockingViewSwitcher">BlockingViewSwitcher</a></li><li><a href="global.html#EditProfile">EditProfile</a></li><li><a href="global.html#EditableSeatRenderer">EditableSeatRenderer</a></li><li><a href="global.html#ErrorPage">ErrorPage</a></li><li><a href="global.html#EventCreation">EventCreation</a></li><li><a href="global.html#EventDetails">EventDetails</a></li><li><a href="global.html#FramedImage">FramedImage</a></li><li><a href="global.html#GeneralAdmissionRenderer">GeneralAdmissionRenderer</a></li><li><a href="global.html#GenericSeatRenderer">GenericSeatRenderer</a></li><li><a href="global.html#HelpCenter">HelpCenter</a></li><li><a href="global.html#Home">Home</a></li><li><a href="global.html#Login">Login</a></li><li><a href="global.html#ManualBlockingSelection">ManualBlockingSelection</a></li><li><a href="global.html#ManualSeatSelection">ManualSeatSelection</a></li><li><a href="global.html#Profile">Profile</a></li><li><a href="global.html#Register">Register</a></li><li><a href="global.html#RowPricingTable">RowPricingTable</a></li><li><a href="global.html#SeatMapContainer">SeatMapContainer</a></li><li><a href="global.html#SeatRenderer">SeatRenderer</a></li><li><a href="global.html#SeatSelectionViewSwitcher">SeatSelectionViewSwitcher</a></li><li><a href="global.html#SectionShapeRenderer">SectionShapeRenderer</a></li><li><a href="global.html#SelectionTopBar">SelectionTopBar</a></li><li><a href="global.html#TicketPurchase">TicketPurchase</a></li><li><a href="global.html#VenueStageRenderer">VenueStageRenderer</a></li><li><a href="global.html#ZoomControls">ZoomControls</a></li><li><a href="global.html#enviarEmailConfirmacionCompra">enviarEmailConfirmacionCompra</a></li><li><a href="global.html#generateTicketNumber">generateTicketNumber</a></li><li><a href="global.html#generateToken">generateToken</a></li><li><a href="global.html#generateValidationCode">generateValidationCode</a></li><li><a href="global.html#returnError">returnError</a></li><li><a href="global.html#tokens">tokens</a></li><li><a href="global.html#transporter">transporter</a></li><li><a href="global.html#useAdvancedZoomPan">useAdvancedZoomPan</a></li><li><a href="global.html#useDeviceDetection">useDeviceDetection</a></li><li><a href="global.html#useUserRole">useUserRole</a></li><li><a href="global.html#verifyAdmin">verifyAdmin</a></li><li><a href="global.html#verifyAuthenticated">verifyAuthenticated</a></li><li><a href="global.html#verifyOwnership">verifyOwnership</a></li><li><a href="global.html#verifyPayPalPayment">verifyPayPalPayment</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.5</a> on Thu Nov 13 2025 19:24:33 GMT+0100 (hora estándar de Europa central)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
